// ==UserScript==
// @name         Erepublik Anniversary Script
// @namespace    https://github.com/driversti/ereplab
// @version      1.0.0
// @description  A userscript to celebrate and enhance the Erepublik Anniversary event.
// @author       driversti
// @match        https://www.erepublik.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=erepublik.com
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @run-at       document-end
// @license      MIT
// @downloadURL  https://github.com/driversti/erepublik-scripts/blob/main/erepublik-anniversary.user.js
// ==/UserScript==


(()=>{var K="ea:debug",F=(...t)=>{try{typeof GM_getValue=="function"&&GM_getValue(K,!1)&&console.log("[EA]",...t)}catch{}};function de(t){if(typeof GM_addStyle=="function")try{GM_addStyle(t);return}catch{}let e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}function ae(){if(F("Booting Erepublik Anniversary userscript"),!/erepublik\.com$/i.test(location.hostname)){F("Not on erepublik.com, aborting");return}de(`
    :root { --ea-accent: #ffae00; }
    .ea-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:10px; background:#1b1f2a; color:#fff; border:1px solid var(--ea-accent); font-size:12px; }

    /* Toasts */
    .ea-toast-container { position: fixed; right: 12px; bottom: 60px; z-index: 2147483647; display: flex; flex-direction: column; gap: 8px; }
    .ea-toast { position: relative; min-width: 200px; max-width: 360px; background: rgba(27,31,42,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 8px; padding: 10px 28px 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); font-size: 13px; line-height: 1.35; }
    .ea-toast.info { border-color: #4aa3ff; }
    .ea-toast.warn { border-color: #ffae00; }
    .ea-toast.error { border-color: #ff5a5a; }
    .ea-toast .ea-close { position: absolute; top: 4px; right: 6px; width: 20px; height: 20px; border: none; background: transparent; color: #ccc; cursor: pointer; font-size: 16px; line-height: 20px; padding: 0; }
    .ea-toast .ea-close:hover { color: #fff; }

    /* Mini panel for Anniversary progress */
    .ea-panel { position: fixed; right: 12px; bottom: 48px; z-index: 2147483647; width: 280px; background: rgba(18,20,28,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.45); overflow: hidden; }
    .ea-panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; background: rgba(255,174,0,0.07); border-bottom: 1px solid rgba(255,174,0,0.35); }
    .ea-panel-title { font-size: 13px; font-weight: 600; }
    .ea-panel-close { background: transparent; border: none; color: #ddd; font-size: 18px; cursor: pointer; line-height: 1; }
    .ea-panel-close:hover { color: #fff; }
    /* Donate (gift) icon in the panel header */
    .ea-panel-donate { background: transparent; border: none; color: #ffd36b; font-size: 18px; cursor: pointer; line-height: 1; text-decoration: none; display:inline-flex; align-items:center; justify-content:center; }
    .ea-panel-donate:hover { color: #fff; text-shadow: 0 0 6px rgba(255,174,0,0.55); }
    .ea-panel-body { padding: 12px; display:flex; flex-direction:column; gap:8px; }
    .ea-kv { display:flex; align-items:center; justify-content:space-between; font-size: 12px; color: #ccc; }
    .ea-progress { position: relative; width: 100%; height: 12px; background: #2a2f3d; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }
    .ea-progress-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg, #ffae00, #ffd36b); box-shadow: inset 0 0 6px rgba(0,0,0,0.4); transition: width 220ms ease; }
    .ea-progress-label { text-align: right; font-size: 11px; color: #bbb; }
  `),typeof GM_registerMenuCommand=="function"&&GM_registerMenuCommand("Toggle Debug Logs",()=>{let t=!GM_getValue(K,!1);GM_setValue(K,t),alert(`Erepublik Anniversary: Debug logs ${t?"enabled":"disabled"}.`)});try{ue(),we(),be()}catch(t){console.error("EA init failed",t)}}function ue(){if(![/^\/?$/i,/^\/en\/?$/i,/^\/en\/(?:citizen|military|economy|politics)/i].some(a=>a.test(location.pathname)))return;let e=document.createElement("div");e.className="ea-badge",e.title="Erepublik Anniversary Userscript (Boilerplate)",e.style.position="fixed",e.style.zIndex="2147483647",e.style.bottom="12px",e.style.right="12px",e.textContent="ðŸŽ‚ Anniversary Mode",document.body.appendChild(e),e.style.cursor="pointer",e.addEventListener("click",()=>ge()),F("Anniversary badge mounted")}var G={container:null,lastShown:new Map};function pe(){if(G.container&&document.body.contains(G.container))return G.container;let t=document.createElement("div");return t.className="ea-toast-container",document.body.appendChild(t),G.container=t,t}function $(t,{kind:e="warn",ttl:a=4500,dedupeFor:n=5*6e4}={}){try{let o=Date.now(),d=G.lastShown.get(t)||0;if(o-d<n)return;G.lastShown.set(t,o);let l=pe(),y=document.createElement("div");y.className=`ea-toast ${e}`;let S=document.createElement("span");S.textContent=t,y.appendChild(S);let s=document.createElement("button");s.className="ea-close",s.type="button",s.setAttribute("aria-label","Close"),s.textContent="Ã—",y.appendChild(s);let i=!1,f=()=>{if(!i){i=!0;try{clearTimeout(w)}catch{}y.style.transition="opacity 250ms ease",y.style.opacity="0",setTimeout(()=>y.remove(),260)}};s.addEventListener("click",f),l.appendChild(y);let w=setTimeout(f,a)}catch{try{alert(t)}catch{}}}var p={el:null};function me(){try{let t=window&&window.status&&window.status.inventory||{},e=Number(t.miles),a=Number(t.distanceNeeded);return{miles:Number.isFinite(e)?e:0,needed:Number.isFinite(a)?a:0}}catch{return{miles:0,needed:0}}}function oe(t){try{return new Intl.NumberFormat(void 0).format(t)}catch{return String(t)}}function fe(){if(p.el&&document.body.contains(p.el))return p.el;let t=document.createElement("div");t.className="ea-panel";let e=document.createElement("div");e.className="ea-panel-header";let a=document.createElement("div");a.className="ea-panel-title",a.textContent="Anniversary Progress";let n=document.createElement("div");n.style.display="inline-flex",n.style.alignItems="center",n.style.gap="10px";let o=document.createElement("a");o.className="ea-panel-donate",o.href="https://www.erepublik.com/en/economy/donate-money/4690052",o.target="_blank",o.rel="noopener noreferrer",o.title="Donate (opens in a new tab)",o.setAttribute("aria-label","Donate"),o.textContent="ðŸŽ";let d=document.createElement("button");d.className="ea-panel-close",d.type="button",d.setAttribute("aria-label","Close"),d.textContent="Ã—",n.appendChild(o),n.appendChild(d),e.appendChild(a),e.appendChild(n);let l=document.createElement("div");l.className="ea-panel-body";let y=document.createElement("div");y.className="ea-kv";let S=document.createElement("div");S.textContent="Distance covered";let s=document.createElement("div");s.className="ea-progress-label",y.appendChild(S),y.appendChild(s);let i=document.createElement("div");i.className="ea-progress";let f=document.createElement("div");f.className="ea-progress-bar",i.appendChild(f);let w=document.createElement("div");w.style.marginTop="6px",w.style.borderTop="1px solid rgba(255,255,255,0.08)",w.style.paddingTop="8px";let I=document.createElement("div");I.className="ea-kv";let L=document.createElement("div");L.textContent="Travel automation";let C=document.createElement("div");C.className="ea-progress-label",I.appendChild(L),I.appendChild(C);let E=document.createElement("div");E.style.display="flex",E.style.flexDirection="column",E.style.alignItems="stretch",E.style.gap="6px",E.style.margin="6px 0 2px";let m=document.createElement("select");m.style.flex="0 0 auto",m.style.width="100%";let q=document.createElement("span");q.textContent="â†”",q.style.opacity="0.6",q.style.display="none";let h=document.createElement("select");h.style.flex="0 0 auto",h.style.width="100%";let c=document.createElement("button");c.type="button",c.textContent="Reload destinations",c.title="Reload destinations",c.style.flex="0 0 auto",c.style.padding="4px 8px",c.style.borderRadius="6px",c.style.border="1px solid rgba(255,255,255,0.25)",c.style.background="rgba(255,255,255,0.06)",c.style.color="#fff",c.style.cursor="pointer",E.appendChild(m),E.appendChild(q),E.appendChild(h);let _=document.createElement("div");_.style.display="flex",_.style.gap="8px",_.style.alignItems="center",_.style.marginTop="2px";let u=document.createElement("button");u.type="button",u.textContent="Start",u.style.flex="0 0 auto",u.style.padding="6px 10px",u.style.borderRadius="6px",u.style.border="1px solid var(--ea-accent)",u.style.background="rgba(255,174,0,0.08)",u.style.color="#fff",u.style.cursor="pointer",_.appendChild(c),_.appendChild(u);let R=document.createElement("div");R.style.fontSize="11px",R.style.color="#bbb",R.style.marginTop="6px";let k=document.createElement("div");k.style.fontSize="11px",k.style.color="#bbb",w.appendChild(I),w.appendChild(E),w.appendChild(_),w.appendChild(R),w.appendChild(k),l.appendChild(y),l.appendChild(i),l.appendChild(w),t.appendChild(e),t.appendChild(l),document.body.appendChild(t);let M=b=>{b.key==="Escape"&&X()};document.addEventListener("keydown",M),d.addEventListener("click",()=>X()),p.el=t,p.refs={right:s,bar:f,travelState:C,toggleBtn:u,statusLine:R,nextLine:k,selA:m,selB:h,refreshBtn:c},p.cleanup=()=>{document.removeEventListener("keydown",M)};try{s.textContent="Refreshingâ€¦"}catch{}V(),re();try{let b=ie(),B="ea:travel:dstA",Y="ea:travel:dstB",J=r=>{let x=document.createElement("option");return x.value=String(r.id),x.textContent=r._label||`${r.name} (${r._countryName||r.countryId})`,x.dataset.countryId=String(r.countryId),x},W=r=>{for(;r.firstChild;)r.removeChild(r.firstChild)},Z=r=>{try{let x=localStorage.getItem(r);return x?Number(x):null}catch{return null}},ee=(r,x)=>{try{localStorage.setItem(r,String(x))}catch{}},U=()=>{let r=Number(m.value||0),x=Number(h.value||0),A=m.selectedOptions[0],j=h.selectedOptions[0],N=A?Number(A.dataset.countryId):0,D=j?Number(j.dataset.countryId):0,O=A?A.textContent:"",T=j?j.textContent:"",v=[];r&&N&&v.push({regionId:r,countryId:N,label:O}),x&&D&&v.push({regionId:x,countryId:D,label:T});let P=v.length===2?[v[0],v[1]]:v.length===1?[v[0]]:[];b.setTargets(P);let z=b.getState(),g=P.length>=2;u.disabled=!z.running&&!g};async function ce({signal:r}={}){let x=se();if(!x)throw new Error("Missing CSRF token");let A=g=>{try{let H=document.cookie.match(new RegExp(`(?:^|; )${g}=([^;]*)`));return H?decodeURIComponent(H[1]):""}catch{return""}},j=erepublik.citizen.regionLocationId,N=new URLSearchParams;N.set("_token",String(x)),N.set("holdingId","0"),N.set("battleId","0"),N.set("regionId",String(j||3));let D=await fetch("/en/main/travelData",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:N,signal:r}),O=await D.json();if(!D.ok||!O)throw new Error(`travelData failed: HTTP ${D.status}`);let T=O.countries||{},v=O.regions||{},P={};Object.values(T).forEach(g=>{g&&g.id&&(P[g.id]=g.name)});let z=Object.values(v).filter(g=>g&&g.id&&g.name&&g.countryId).map(g=>({id:Number(g.id),name:String(g.name),countryId:Number(g.countryId),_countryName:P[Number(g.countryId)]||`#${g.countryId}`})).sort((g,H)=>g.name.localeCompare(H.name));return z.forEach(g=>{g._label=`${g.name} (${g._countryName})`}),z}let te=async()=>{try{m.disabled=h.disabled=c.disabled=!0,W(m),W(h);let r=T=>{let v=document.createElement("option");return v.value="",v.textContent=T,v};m.appendChild(r("Select region Aâ€¦")),h.appendChild(r("Select region Bâ€¦")),(await ce()).forEach(T=>{m.appendChild(J(T)),h.appendChild(J(T))});let A=Z(B),j=Z(Y),N=(T,v)=>v&&[...T.options].find(z=>Number(z.value)===Number(v))?(T.value=String(v),!0):!1,D=N(m,A),O=N(h,j);if(D||(D=N(m,714)),O||(O=N(h,173)),m.value&&m.value===h.value){let T=[...h.options].find(v=>v.value&&v.value!==m.value);T&&(h.value=T.value)}U()}catch(r){F("Failed to populate travel selectors",r&&r.message?r.message:r),$("Failed to load travel destinations",{kind:"error"})}finally{m.disabled=h.disabled=!1,c.disabled=!1}};m.addEventListener("change",()=>{m.value&&ee(B,m.value),U()}),h.addEventListener("change",()=>{h.value&&ee(Y,h.value),U()}),c.addEventListener("click",()=>te());let ne=()=>{let r=b.getState();C.textContent=r.running?"Running":"Stopped";let x=!!m.value&&!!h.value&&m.value!==h.value;if(u.textContent=r.running?"Stop":"Start",u.disabled=r.running?!1:!x,R.textContent=`Hops: ${r.hops} | Last: ${r.lastMessage||"â€”"}`,r.running&&r.nextAt){let A=Math.max(0,r.nextAt-Date.now());k.textContent=`Next hop to ${r.nextLabel} in ${le(Math.ceil(A/1e3))}`}else k.textContent=`Next hop: ${r.nextLabel}`};b.onChange(ne),u.addEventListener("click",()=>{if(b.getState().running){b.stop();return}if(!(!!m.value&&!!h.value&&m.value!==h.value)){$("Pick two different regions first",{kind:"warn"});return}b.start()}),ne(),te()}catch(b){F("Travel UI failed to wire",b&&b.message?b.message:b)}return t}function V(){if(!p.el||!p.refs)return;let{miles:t,needed:e}=me(),a=Math.max(0,e),n=Math.max(0,t),o=a>0?Math.max(0,Math.min(100,n/a*100)):0;try{p.refs.bar.style.width=`${o}%`}catch{}try{p.refs.right.textContent=`${oe(n)} / ${oe(a)} miles (${Math.floor(o)}%)`}catch{}}async function he({signal:t}={}){let a=await fetch("/en/main/anniversaryQuestData",{method:"GET",headers:{accept:"application/json, text/javascript, */*; q=0.01","x-requested-with":"XMLHttpRequest"},credentials:"same-origin",cache:"no-store",signal:t}),n=null;try{n=await a.json()}catch{}if(!a.ok||!n){let y=n&&(n.message||n.error)||`HTTP ${a.status}`,S=new Error(`anniversaryQuestData failed: ${y}`);throw S.status=a.status,S}let o=n&&n.status&&n.status.inventory||{},d=Number(o.miles),l=Number(o.distanceNeeded);return{miles:Number.isFinite(d)?d:0,needed:Number.isFinite(l)?l:0}}async function re(){try{p.abortCtrl&&p.abortCtrl.abort()}catch{}let t=new AbortController;p.abortCtrl=t;try{p.refs&&p.refs.right&&(p.refs.right.textContent="Refreshingâ€¦")}catch{}try{let e=await he({signal:t.signal});try{let a=window||{};a.status=a.status||{},a.status.inventory=a.status.inventory||{},a.status.inventory.miles=e.miles,a.status.inventory.distanceNeeded=e.needed}catch{}p.el&&document.body.contains(p.el)&&V()}catch(e){F("Refresh failed",e&&e.message?e.message:e),$("Failed to refresh Anniversary data. Showing cached values.",{kind:"warn"}),p.el&&document.body.contains(p.el)&&V()}finally{p.abortCtrl=null}}function X(){if(p.el){try{try{p.abortCtrl&&p.abortCtrl.abort()}catch{}p.cleanup&&p.cleanup()}catch{}p.el.remove(),p.el=null}}function ge(){p.el&&document.body.contains(p.el)?X():fe()}function se(){let t=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(t)return t;try{let e=document.querySelector('meta[name="csrf-token"], meta[name="csrf_token"], input[name="_token"]');if(e)return e.content||e.value||null}catch{}return null}async function ye(t,e){let a=se();if(!a)throw new Error("Missing CSRF token");let n=new URLSearchParams;n.set("check","moveAction"),n.set("_token",String(a)),n.set("travelMethod","ticketOnly"),n.set("inRegionId",String(t)),n.set("toCountryId",String(e));let o=await fetch("/en/main/travel",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:n}),d=null;try{d=await o.json()}catch{}if(!o.ok){let l=d&&(d.message||d.error)||`HTTP ${o.status}`,y=new Error(l);throw y.status=o.status,y}return d||{message:"OK"}}var Q=null;function ie(){if(Q)return Q;let t=new Set,e=()=>{try{t.forEach(s=>s())}catch{}},a=[],n={running:!1,index:0,hops:0,nextAt:null,lastMessage:""},o=null,d=()=>{o&&(clearTimeout(o),o=null)},l=(s=4e3,i=6e3)=>{let f=Math.floor(s+Math.random()*Math.max(0,i-s));n.nextAt=Date.now()+f,d(),o=setTimeout(y,f),e()},y=async()=>{if(!n.running)return;if(!a||a.length===0){n.lastMessage="No destinations selected",e(),S.stop();return}let s=a[n.index%a.length];try{n.lastMessage=`Flying to ${s.label}â€¦`,e();let i=await ye(s.regionId,s.countryId);n.hops+=1,n.index=(n.index+1)%a.length;try{await re()}catch{}let f=i&&(i.message||i.success)?String(i.message||i.success):"OK";n.lastMessage=`OK â†’ ${f}`,e(),l(4e3,6e3)}catch(i){let f=i&&i.status?Number(i.status):0,w=i&&i.message?i.message:"Error";n.lastMessage=`Error (${f||"n/a"}): ${w}`,$(`Travel failed${f?` (${f})`:""}: ${w}`,{kind:"error",ttl:5e3}),e(),f===429?l(8e3,12e3):l(5e3,7e3)}},S={start(){n.running||(n.running=!0,n.lastMessage="Startingâ€¦",$("Travel automation started",{kind:"info"}),l(250,750),e())},stop(){n.running&&(n.running=!1,d(),n.nextAt=null,$("Travel automation stopped",{kind:"warn"}),e())},setTargets(s){try{a=(Array.isArray(s)?s.filter(Boolean):[]).map(f=>({regionId:Number(f.regionId),countryId:Number(f.countryId),label:String(f.label||"")})),n.index=0,e()}catch{}},getState(){let s=a&&a.length?a[n.index%a.length]:{label:"â€”"};return{...n,nextLabel:s.label}},onChange(s){return typeof s=="function"&&t.add(s),()=>t.delete(s)}};return Q=S,S}function be(){try{window.EA_Travel=ie()}catch{}}async function xe(t){if(!Number.isFinite(Number(t)))throw new Error("Invalid nodeId");let e=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(!e)throw new Error("Missing csrfToken on page");let a=new URLSearchParams;a.set("nodeId",String(t)),a.set("_token",String(e));let n=await fetch("/en/main/map-rewards-unlock",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:a}),o=null;try{o=await n.json()}catch{}if(!n.ok){let d=o&&(o.message||o.error)||`HTTP ${n.status}`,l=new Error(d);throw l.status=n.status,l}return o||{message:"OK"}}function le(t){let e=Math.max(0,Math.floor(t)),a=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60),d=e%60,l=[];return a&&l.push(`${a}d`),n&&l.push(`${n}h`),o&&l.length<2&&l.push(`${o}m`),l.length||l.push(`${d}s`),l.slice(0,2).join(" ")}function ve(t){try{return new Date(t).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}catch{let a=new Date(t),n=String(a.getHours()).padStart(2,"0"),o=String(a.getMinutes()).padStart(2,"0");return`${n}:${o}`}}function we(){let t="/en/main/anniversaryQuestData",e=!1,a=0,n=null,o=null,d=!1,l=new Map,y=()=>{let s=Date.now();for(let[i,f]of l)s-f>2*6e4&&l.delete(i)},S=async()=>{if(!e){e=!0;try{let s=await fetch(t,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);let i=await s.json(),f=i&&i.status&&Array.isArray(i.status.queue)?i.status.queue:[],w=f.length>=3;if(F("QuestData queue size:",f.length),w){let I="No empty slots";try{let L=f.map(C=>Number(C&&C.remainingTime)).filter(C=>Number.isFinite(C)&&C>0);if(L.length>0){let C=Math.min(...L),E=Math.max(0,Math.ceil(C/60)*60),m=Date.now()+E*1e3;I+=` â€” next in ${le(E)} (at ${ve(m)})`}}catch{}$(I,{kind:"warn",ttl:4e3,dedupeFor:59e3})}else try{let I=i&&i.status&&i.status.progress||{},L=Array.isArray(i&&i.neighbors)?i.neighbors:[],C=i&&i.cities||{},E=new Set(f.map(c=>c&&c.nodeId).filter(Boolean)),m=new Set(Object.values(I).filter(c=>c&&(c.nodeStatus==="unclaimed"||c.nodeStatus==="claimed")).map(c=>c.nodeId)),q=new Set(Object.values(I).filter(c=>c&&c.nodeStatus==="unlocking").map(c=>c.nodeId)),h=new Set([...m,...E,...q]);if(h.size>0&&L.length>0){let c=new Set;L.forEach(u=>{!u||typeof u.nodeId!="number"||typeof u.neighborId!="number"||(h.has(u.nodeId)&&c.add(u.neighborId),h.has(u.neighborId)&&c.add(u.nodeId))});let _=[...c].filter(u=>!m.has(u)).filter(u=>!E.has(u)).filter(u=>!q.has(u));if(_.length>0){let R=`Available cities to open: ${_.map(k=>{let M=C&&C[k];return M&&M.name?M.name:String(k)}).join(", ")}`;if($(R,{kind:"info",ttl:5e4,dedupeFor:5e4}),y(),!d){let k=_.find(M=>!l.has(M));if(typeof k=="number"){d=!0,l.set(k,Date.now());let M=C&&C[k]&&C[k].name||String(k);xe(k).then(b=>{let B=b&&b.message||"Successfully started node unlock";$(`Added to queue: ${M} (#${k}) â€” ${B}`,{kind:"info",ttl:8e3,dedupeFor:4e3})}).catch(b=>{let B=b&&b.message?b.message:"Failed to add city to queue";$(`Failed to add ${M} (#${k}) â€” ${B}`,{kind:"error",ttl:9e3,dedupeFor:2e3})}).finally(()=>{d=!1,setTimeout(()=>{S()},150)})}}}}}catch(I){F("Next cities suggestion failed",I)}o=w,a=0}catch(s){a+=1,F("QuestData poll failed",s),a===3&&$("Anniversary data polling temporarily failing",{kind:"error",ttl:5e3,dedupeFor:15*6e4})}finally{e=!1}}};S(),n=setInterval(S,6e4),window.addEventListener("beforeunload",()=>{n&&clearInterval(n)},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ae,{once:!0}):ae();})();
