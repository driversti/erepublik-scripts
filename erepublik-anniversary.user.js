// ==UserScript==
// @name         Erepublik Anniversary Script
// @namespace    https://github.com/driversti/ereplab
// @version      1.0.0
// @description  A userscript to celebrate and enhance the Erepublik Anniversary event.
// @author       driversti
// @match        https://www.erepublik.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=erepublik.com
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @run-at       document-end
// @license      MIT
// ==/UserScript==


(()=>{var K="ea:debug",D=(...t)=>{try{typeof GM_getValue=="function"&&GM_getValue(K,!1)&&console.log("[EA]",...t)}catch{}};function le(t){if(typeof GM_addStyle=="function")try{GM_addStyle(t);return}catch{}let e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}function te(){if(D("Booting Erepublik Anniversary userscript"),!/erepublik\.com$/i.test(location.hostname)){D("Not on erepublik.com, aborting");return}le(`
    :root { --ea-accent: #ffae00; }
    .ea-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:10px; background:#1b1f2a; color:#fff; border:1px solid var(--ea-accent); font-size:12px; }

    /* Toasts */
    .ea-toast-container { position: fixed; right: 12px; bottom: 60px; z-index: 2147483647; display: flex; flex-direction: column; gap: 8px; }
    .ea-toast { position: relative; min-width: 200px; max-width: 360px; background: rgba(27,31,42,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 8px; padding: 10px 28px 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); font-size: 13px; line-height: 1.35; }
    .ea-toast.info { border-color: #4aa3ff; }
    .ea-toast.warn { border-color: #ffae00; }
    .ea-toast.error { border-color: #ff5a5a; }
    .ea-toast .ea-close { position: absolute; top: 4px; right: 6px; width: 20px; height: 20px; border: none; background: transparent; color: #ccc; cursor: pointer; font-size: 16px; line-height: 20px; padding: 0; }
    .ea-toast .ea-close:hover { color: #fff; }

    /* Mini panel for Anniversary progress */
    .ea-panel { position: fixed; right: 12px; bottom: 48px; z-index: 2147483647; width: 280px; background: rgba(18,20,28,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.45); overflow: hidden; }
    .ea-panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; background: rgba(255,174,0,0.07); border-bottom: 1px solid rgba(255,174,0,0.35); }
    .ea-panel-title { font-size: 13px; font-weight: 600; }
    .ea-panel-close { background: transparent; border: none; color: #ddd; font-size: 18px; cursor: pointer; line-height: 1; }
    .ea-panel-close:hover { color: #fff; }
    .ea-panel-body { padding: 12px; display:flex; flex-direction:column; gap:8px; }
    .ea-kv { display:flex; align-items:center; justify-content:space-between; font-size: 12px; color: #ccc; }
    .ea-progress { position: relative; width: 100%; height: 12px; background: #2a2f3d; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }
    .ea-progress-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg, #ffae00, #ffd36b); box-shadow: inset 0 0 6px rgba(0,0,0,0.4); transition: width 220ms ease; }
    .ea-progress-label { text-align: right; font-size: 11px; color: #bbb; }
  `),typeof GM_registerMenuCommand=="function"&&GM_registerMenuCommand("Toggle Debug Logs",()=>{let t=!GM_getValue(K,!1);GM_setValue(K,t),alert(`Erepublik Anniversary: Debug logs ${t?"enabled":"disabled"}.`)});try{ce(),xe(),ge()}catch(t){console.error("EA init failed",t)}}function ce(){if(![/^\/?$/i,/^\/en\/?$/i,/^\/en\/(?:citizen|military|economy|politics)/i].some(a=>a.test(location.pathname)))return;let e=document.createElement("div");e.className="ea-badge",e.title="Erepublik Anniversary Userscript (Boilerplate)",e.style.position="fixed",e.style.zIndex="2147483647",e.style.bottom="12px",e.style.right="12px",e.textContent="ðŸŽ‚ Anniversary Mode",document.body.appendChild(e),e.style.cursor="pointer",e.addEventListener("click",()=>fe()),D("Anniversary badge mounted")}var z={container:null,lastShown:new Map};function de(){if(z.container&&document.body.contains(z.container))return z.container;let t=document.createElement("div");return t.className="ea-toast-container",document.body.appendChild(t),z.container=t,t}function M(t,{kind:e="warn",ttl:a=4500,dedupeFor:n=5*6e4}={}){try{let r=Date.now(),u=z.lastShown.get(t)||0;if(r-u<n)return;z.lastShown.set(t,r);let d=de(),y=document.createElement("div");y.className=`ea-toast ${e}`;let C=document.createElement("span");C.textContent=t,y.appendChild(C);let i=document.createElement("button");i.className="ea-close",i.type="button",i.setAttribute("aria-label","Close"),i.textContent="Ã—",y.appendChild(i);let o=!1,m=()=>{if(!o){o=!0;try{clearTimeout(I)}catch{}y.style.transition="opacity 250ms ease",y.style.opacity="0",setTimeout(()=>y.remove(),260)}};i.addEventListener("click",m),d.appendChild(y);let I=setTimeout(m,a)}catch{try{alert(t)}catch{}}}var p={el:null};function ue(){try{let t=window&&window.status&&window.status.inventory||{},e=Number(t.miles),a=Number(t.distanceNeeded);return{miles:Number.isFinite(e)?e:0,needed:Number.isFinite(a)?a:0}}catch{return{miles:0,needed:0}}}function ne(t){try{return new Intl.NumberFormat(void 0).format(t)}catch{return String(t)}}function pe(){if(p.el&&document.body.contains(p.el))return p.el;let t=document.createElement("div");t.className="ea-panel";let e=document.createElement("div");e.className="ea-panel-header";let a=document.createElement("div");a.className="ea-panel-title",a.textContent="Anniversary Progress";let n=document.createElement("button");n.className="ea-panel-close",n.type="button",n.setAttribute("aria-label","Close"),n.textContent="Ã—",e.appendChild(a),e.appendChild(n);let r=document.createElement("div");r.className="ea-panel-body";let u=document.createElement("div");u.className="ea-kv";let d=document.createElement("div");d.textContent="Distance covered";let y=document.createElement("div");y.className="ea-progress-label",u.appendChild(d),u.appendChild(y);let C=document.createElement("div");C.className="ea-progress";let i=document.createElement("div");i.className="ea-progress-bar",C.appendChild(i);let o=document.createElement("div");o.style.marginTop="6px",o.style.borderTop="1px solid rgba(255,255,255,0.08)",o.style.paddingTop="8px";let m=document.createElement("div");m.className="ea-kv";let I=document.createElement("div");I.textContent="Travel automation";let E=document.createElement("div");E.className="ea-progress-label",m.appendChild(I),m.appendChild(E);let k=document.createElement("div");k.style.display="flex",k.style.flexDirection="column",k.style.alignItems="stretch",k.style.gap="6px",k.style.margin="6px 0 2px";let l=document.createElement("select");l.style.flex="0 0 auto",l.style.width="100%";let $=document.createElement("span");$.textContent="â†”",$.style.opacity="0.6",$.style.display="none";let f=document.createElement("select");f.style.flex="0 0 auto",f.style.width="100%";let w=document.createElement("button");w.type="button",w.textContent="Reload destinations",w.title="Reload destinations",w.style.flex="0 0 auto",w.style.padding="4px 8px",w.style.borderRadius="6px",w.style.border="1px solid rgba(255,255,255,0.25)",w.style.background="rgba(255,255,255,0.06)",w.style.color="#fff",w.style.cursor="pointer",k.appendChild(l),k.appendChild($),k.appendChild(f);let N=document.createElement("div");N.style.display="flex",N.style.gap="8px",N.style.alignItems="center",N.style.marginTop="2px";let c=document.createElement("button");c.type="button",c.textContent="Start",c.style.flex="0 0 auto",c.style.padding="6px 10px",c.style.borderRadius="6px",c.style.border="1px solid var(--ea-accent)",c.style.background="rgba(255,174,0,0.08)",c.style.color="#fff",c.style.cursor="pointer",N.appendChild(w),N.appendChild(c);let A=document.createElement("div");A.style.fontSize="11px",A.style.color="#bbb",A.style.marginTop="6px";let b=document.createElement("div");b.style.fontSize="11px",b.style.color="#bbb",o.appendChild(m),o.appendChild(k),o.appendChild(N),o.appendChild(A),o.appendChild(b),r.appendChild(u),r.appendChild(C),r.appendChild(o),t.appendChild(e),t.appendChild(r),document.body.appendChild(t);let H=h=>{h.key==="Escape"&&X()};document.addEventListener("keydown",H),n.addEventListener("click",()=>X()),p.el=t,p.refs={right:y,bar:i,travelState:E,toggleBtn:c,statusLine:A,nextLine:b,selA:l,selB:f,refreshBtn:w},p.cleanup=()=>{document.removeEventListener("keydown",H)};try{y.textContent="Refreshingâ€¦"}catch{}V(),ae();try{let h=se(),_="ea:travel:dstA",F="ea:travel:dstB",q=s=>{let x=document.createElement("option");return x.value=String(s.id),x.textContent=s._label||`${s.name} (${s._countryName||s.countryId})`,x.dataset.countryId=String(s.countryId),x},Y=s=>{for(;s.firstChild;)s.removeChild(s.firstChild)},J=s=>{try{let x=localStorage.getItem(s);return x?Number(x):null}catch{return null}},W=(s,x)=>{try{localStorage.setItem(s,String(x))}catch{}},U=()=>{let s=Number(l.value||0),x=Number(f.value||0),L=l.selectedOptions[0],j=f.selectedOptions[0],T=L?Number(L.dataset.countryId):0,R=j?Number(j.dataset.countryId):0,O=L?L.textContent:"",S=j?j.textContent:"",v=[];s&&T&&v.push({regionId:s,countryId:T,label:O}),x&&R&&v.push({regionId:x,countryId:R,label:S});let B=v.length===2?[v[0],v[1]]:v.length===1?[v[0]]:[];h.setTargets(B);let P=h.getState(),g=B.length>=2;c.disabled=!P.running&&!g};async function ie({signal:s}={}){let x=oe();if(!x)throw new Error("Missing CSRF token");let L=g=>{try{let G=document.cookie.match(new RegExp(`(?:^|; )${g}=([^;]*)`));return G?decodeURIComponent(G[1]):""}catch{return""}},j=erepublik.citizen.regionLocationId,T=new URLSearchParams;T.set("_token",String(x)),T.set("holdingId","0"),T.set("battleId","0"),T.set("regionId",String(j||3));let R=await fetch("/en/main/travelData",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:T,signal:s}),O=await R.json();if(!R.ok||!O)throw new Error(`travelData failed: HTTP ${R.status}`);let S=O.countries||{},v=O.regions||{},B={};Object.values(S).forEach(g=>{g&&g.id&&(B[g.id]=g.name)});let P=Object.values(v).filter(g=>g&&g.id&&g.name&&g.countryId).map(g=>({id:Number(g.id),name:String(g.name),countryId:Number(g.countryId),_countryName:B[Number(g.countryId)]||`#${g.countryId}`})).sort((g,G)=>g.name.localeCompare(G.name));return P.forEach(g=>{g._label=`${g.name} (${g._countryName})`}),P}let Z=async()=>{try{l.disabled=f.disabled=w.disabled=!0,Y(l),Y(f);let s=S=>{let v=document.createElement("option");return v.value="",v.textContent=S,v};l.appendChild(s("Select region Aâ€¦")),f.appendChild(s("Select region Bâ€¦")),(await ie()).forEach(S=>{l.appendChild(q(S)),f.appendChild(q(S))});let L=J(_),j=J(F),T=(S,v)=>v&&[...S.options].find(P=>Number(P.value)===Number(v))?(S.value=String(v),!0):!1,R=T(l,L),O=T(f,j);if(R||(R=T(l,714)),O||(O=T(f,173)),l.value&&l.value===f.value){let S=[...f.options].find(v=>v.value&&v.value!==l.value);S&&(f.value=S.value)}U()}catch(s){D("Failed to populate travel selectors",s&&s.message?s.message:s),M("Failed to load travel destinations",{kind:"error"})}finally{l.disabled=f.disabled=!1,w.disabled=!1}};l.addEventListener("change",()=>{l.value&&W(_,l.value),U()}),f.addEventListener("change",()=>{f.value&&W(F,f.value),U()}),w.addEventListener("click",()=>Z());let ee=()=>{let s=h.getState();E.textContent=s.running?"Running":"Stopped";let x=!!l.value&&!!f.value&&l.value!==f.value;if(c.textContent=s.running?"Stop":"Start",c.disabled=s.running?!1:!x,A.textContent=`Hops: ${s.hops} | Last: ${s.lastMessage||"â€”"}`,s.running&&s.nextAt){let L=Math.max(0,s.nextAt-Date.now());b.textContent=`Next hop to ${s.nextLabel} in ${re(Math.ceil(L/1e3))}`}else b.textContent=`Next hop: ${s.nextLabel}`};h.onChange(ee),c.addEventListener("click",()=>{if(h.getState().running){h.stop();return}if(!(!!l.value&&!!f.value&&l.value!==f.value)){M("Pick two different regions first",{kind:"warn"});return}h.start()}),ee(),Z()}catch(h){D("Travel UI failed to wire",h&&h.message?h.message:h)}return t}function V(){if(!p.el||!p.refs)return;let{miles:t,needed:e}=ue(),a=Math.max(0,e),n=Math.max(0,t),r=a>0?Math.max(0,Math.min(100,n/a*100)):0;try{p.refs.bar.style.width=`${r}%`}catch{}try{p.refs.right.textContent=`${ne(n)} / ${ne(a)} miles (${Math.floor(r)}%)`}catch{}}async function me({signal:t}={}){let a=await fetch("/en/main/anniversaryQuestData",{method:"GET",headers:{accept:"application/json, text/javascript, */*; q=0.01","x-requested-with":"XMLHttpRequest"},credentials:"same-origin",cache:"no-store",signal:t}),n=null;try{n=await a.json()}catch{}if(!a.ok||!n){let y=n&&(n.message||n.error)||`HTTP ${a.status}`,C=new Error(`anniversaryQuestData failed: ${y}`);throw C.status=a.status,C}let r=n&&n.status&&n.status.inventory||{},u=Number(r.miles),d=Number(r.distanceNeeded);return{miles:Number.isFinite(u)?u:0,needed:Number.isFinite(d)?d:0}}async function ae(){try{p.abortCtrl&&p.abortCtrl.abort()}catch{}let t=new AbortController;p.abortCtrl=t;try{p.refs&&p.refs.right&&(p.refs.right.textContent="Refreshingâ€¦")}catch{}try{let e=await me({signal:t.signal});try{let a=window||{};a.status=a.status||{},a.status.inventory=a.status.inventory||{},a.status.inventory.miles=e.miles,a.status.inventory.distanceNeeded=e.needed}catch{}p.el&&document.body.contains(p.el)&&V()}catch(e){D("Refresh failed",e&&e.message?e.message:e),M("Failed to refresh Anniversary data. Showing cached values.",{kind:"warn"}),p.el&&document.body.contains(p.el)&&V()}finally{p.abortCtrl=null}}function X(){if(p.el){try{try{p.abortCtrl&&p.abortCtrl.abort()}catch{}p.cleanup&&p.cleanup()}catch{}p.el.remove(),p.el=null}}function fe(){p.el&&document.body.contains(p.el)?X():pe()}function oe(){let t=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(t)return t;try{let e=document.querySelector('meta[name="csrf-token"], meta[name="csrf_token"], input[name="_token"]');if(e)return e.content||e.value||null}catch{}return null}async function he(t,e){let a=oe();if(!a)throw new Error("Missing CSRF token");let n=new URLSearchParams;n.set("check","moveAction"),n.set("_token",String(a)),n.set("travelMethod","ticketOnly"),n.set("inRegionId",String(t)),n.set("toCountryId",String(e));let r=await fetch("/en/main/travel",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:n}),u=null;try{u=await r.json()}catch{}if(!r.ok){let d=u&&(u.message||u.error)||`HTTP ${r.status}`,y=new Error(d);throw y.status=r.status,y}return u||{message:"OK"}}var Q=null;function se(){if(Q)return Q;let t=new Set,e=()=>{try{t.forEach(i=>i())}catch{}},a=[],n={running:!1,index:0,hops:0,nextAt:null,lastMessage:""},r=null,u=()=>{r&&(clearTimeout(r),r=null)},d=(i=4e3,o=6e3)=>{let m=Math.floor(i+Math.random()*Math.max(0,o-i));n.nextAt=Date.now()+m,u(),r=setTimeout(y,m),e()},y=async()=>{if(!n.running)return;if(!a||a.length===0){n.lastMessage="No destinations selected",e(),C.stop();return}let i=a[n.index%a.length];try{n.lastMessage=`Flying to ${i.label}â€¦`,e();let o=await he(i.regionId,i.countryId);n.hops+=1,n.index=(n.index+1)%a.length;try{await ae()}catch{}let m=o&&(o.message||o.success)?String(o.message||o.success):"OK";n.lastMessage=`OK â†’ ${m}`,e(),d(4e3,6e3)}catch(o){let m=o&&o.status?Number(o.status):0,I=o&&o.message?o.message:"Error";n.lastMessage=`Error (${m||"n/a"}): ${I}`,M(`Travel failed${m?` (${m})`:""}: ${I}`,{kind:"error",ttl:5e3}),e(),m===429?d(8e3,12e3):d(5e3,7e3)}},C={start(){n.running||(n.running=!0,n.lastMessage="Startingâ€¦",M("Travel automation started",{kind:"info"}),d(250,750),e())},stop(){n.running&&(n.running=!1,u(),n.nextAt=null,M("Travel automation stopped",{kind:"warn"}),e())},setTargets(i){try{a=(Array.isArray(i)?i.filter(Boolean):[]).map(m=>({regionId:Number(m.regionId),countryId:Number(m.countryId),label:String(m.label||"")})),n.index=0,e()}catch{}},getState(){let i=a&&a.length?a[n.index%a.length]:{label:"â€”"};return{...n,nextLabel:i.label}},onChange(i){return typeof i=="function"&&t.add(i),()=>t.delete(i)}};return Q=C,C}function ge(){try{window.EA_Travel=se()}catch{}}async function ye(t){if(!Number.isFinite(Number(t)))throw new Error("Invalid nodeId");let e=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(!e)throw new Error("Missing csrfToken on page");let a=new URLSearchParams;a.set("nodeId",String(t)),a.set("_token",String(e));let n=await fetch("/en/main/map-rewards-unlock",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:a}),r=null;try{r=await n.json()}catch{}if(!n.ok){let u=r&&(r.message||r.error)||`HTTP ${n.status}`,d=new Error(u);throw d.status=n.status,d}return r||{message:"OK"}}function re(t){let e=Math.max(0,Math.floor(t)),a=Math.floor(e/86400),n=Math.floor(e%86400/3600),r=Math.floor(e%3600/60),u=e%60,d=[];return a&&d.push(`${a}d`),n&&d.push(`${n}h`),r&&d.length<2&&d.push(`${r}m`),d.length||d.push(`${u}s`),d.slice(0,2).join(" ")}function be(t){try{return new Date(t).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}catch{let a=new Date(t),n=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0");return`${n}:${r}`}}function xe(){let t="/en/main/anniversaryQuestData",e=!1,a=0,n=null,r=null,u=!1,d=new Map,y=()=>{let i=Date.now();for(let[o,m]of d)i-m>2*6e4&&d.delete(o)},C=async()=>{if(!e){e=!0;try{let i=await fetch(t,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);let o=await i.json(),m=o&&o.status&&Array.isArray(o.status.queue)?o.status.queue:[],I=m.length>=3;if(D("QuestData queue size:",m.length),I){let E="No empty slots";try{let k=m.map(l=>Number(l&&l.remainingTime)).filter(l=>Number.isFinite(l)&&l>0);if(k.length>0){let l=Math.min(...k),$=Math.max(0,Math.ceil(l/60)*60),f=Date.now()+$*1e3;E+=` â€” next in ${re($)} (at ${be(f)})`}}catch{}M(E,{kind:"warn",ttl:4e3,dedupeFor:59e3})}else try{let E=o&&o.status&&o.status.progress||{},k=Array.isArray(o&&o.neighbors)?o.neighbors:[],l=o&&o.cities||{},$=new Set(m.map(c=>c&&c.nodeId).filter(Boolean)),f=new Set(Object.values(E).filter(c=>c&&(c.nodeStatus==="unclaimed"||c.nodeStatus==="claimed")).map(c=>c.nodeId)),w=new Set(Object.values(E).filter(c=>c&&c.nodeStatus==="unlocking").map(c=>c.nodeId)),N=new Set([...f,...$,...w]);if(N.size>0&&k.length>0){let c=new Set;k.forEach(b=>{!b||typeof b.nodeId!="number"||typeof b.neighborId!="number"||(N.has(b.nodeId)&&c.add(b.neighborId),N.has(b.neighborId)&&c.add(b.nodeId))});let A=[...c].filter(b=>!f.has(b)).filter(b=>!$.has(b)).filter(b=>!w.has(b));if(A.length>0){let H=`Available cities to open: ${A.map(h=>{let _=l&&l[h];return _&&_.name?_.name:String(h)}).join(", ")}`;if(M(H,{kind:"info",ttl:5e4,dedupeFor:5e4}),y(),!u){let h=A.find(_=>!d.has(_));if(typeof h=="number"){u=!0,d.set(h,Date.now());let _=l&&l[h]&&l[h].name||String(h);ye(h).then(F=>{let q=F&&F.message||"Successfully started node unlock";M(`Added to queue: ${_} (#${h}) â€” ${q}`,{kind:"info",ttl:8e3,dedupeFor:4e3})}).catch(F=>{let q=F&&F.message?F.message:"Failed to add city to queue";M(`Failed to add ${_} (#${h}) â€” ${q}`,{kind:"error",ttl:9e3,dedupeFor:2e3})}).finally(()=>{u=!1,setTimeout(()=>{C()},150)})}}}}}catch(E){D("Next cities suggestion failed",E)}r=I,a=0}catch(i){a+=1,D("QuestData poll failed",i),a===3&&M("Anniversary data polling temporarily failing",{kind:"error",ttl:5e3,dedupeFor:15*6e4})}finally{e=!1}}};C(),n=setInterval(C,6e4),window.addEventListener("beforeunload",()=>{n&&clearInterval(n)},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",te,{once:!0}):te();})();
