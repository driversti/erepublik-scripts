// ==UserScript==
// @name         Erepublik Anniversary Script
// @namespace    https://github.com/driversti/ereplab
// @version      1.1.4
// @description  A userscript to celebrate and enhance the Erepublik Anniversary event.
// @author       driversti
// @match        https://www.erepublik.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=erepublik.com
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @run-at       document-end
// @license      proprietary
// @downloadURL  https://github.com/driversti/erepublik-scripts/raw/refs/heads/main/erepublik-anniversary.user.js
// @updateURL  https://github.com/driversti/erepublik-scripts/raw/refs/heads/main/erepublik-anniversary.user.js
// ==/UserScript==


(()=>{var Z="ea:debug",_=(...t)=>{try{typeof GM_getValue=="function"&&GM_getValue(Z,!1)&&console.log("[EA]",...t)}catch{}},fe="1.1.4";function ve(){try{if(typeof window!="undefined"&&window.erepublik&&window.erepublik.citizen){let t=window.erepublik.citizen.citizenId;if(t!=null){let e=Number(t);if(Number.isFinite(e)&&e>0)return _("Detected citizenId from window.erepublik"),e}}if(typeof unsafeWindow!="undefined"&&unsafeWindow.erepublik&&unsafeWindow.erepublik.citizen){let t=unsafeWindow.erepublik.citizen.citizenId;if(t!=null){let e=Number(t);if(Number.isFinite(e)&&e>0)return _("Detected citizenId from unsafeWindow.erepublik"),e}}}catch{}return _("Citizen ID not available via in-page globals; DOM detection is disabled"),null}function we(){if(!(J&&J.size))return _("Authorization allowlist is empty; denying access"),!1;let t=ve();if(!t)return _("Could not determine citizen ID; denying access"),!1;let e=J.has(t);return e||_(`Citizen ${t} is not in allowlist; denying access`),e}function Ce(t){if(typeof GM_addStyle=="function")try{GM_addStyle(t);return}catch{}let e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}function B(t){return W?!0:(_(`Blocked action${t?`: ${t}`:""} â€” not authorized`),!1)}function ue(){if(_(`Booting Erepublik Anniversary userscript v${fe}`),!/erepublik\.com$/i.test(location.hostname)){_("Not on erepublik.com, aborting");return}W=!!we(),Ce(`
    :root { --ea-accent: #ffae00; }
    .ea-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:10px; background:#1b1f2a; color:#fff; border:1px solid var(--ea-accent); font-size:12px; }
    .ea-auth-indicator { margin-left: 8px; font-size: 14px; line-height: 1; }

    /* Toasts */
    .ea-toast-container { position: fixed; right: 12px; bottom: 60px; z-index: 2147483647; display: flex; flex-direction: column; gap: 8px; }
    .ea-toast { position: relative; min-width: 200px; max-width: 360px; background: rgba(27,31,42,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 8px; padding: 10px 28px 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); font-size: 13px; line-height: 1.35; }
    .ea-toast.info { border-color: #4aa3ff; }
    .ea-toast.warn { border-color: #ffae00; }
    .ea-toast.error { border-color: #ff5a5a; }
    .ea-toast .ea-close { position: absolute; top: 4px; right: 6px; width: 20px; height: 20px; border: none; background: transparent; color: #ccc; cursor: pointer; font-size: 16px; line-height: 20px; padding: 0; }
    .ea-toast .ea-close:hover { color: #fff; }

    /* Mini panel for Anniversary progress */
    .ea-panel { position: fixed; right: 12px; bottom: 48px; z-index: 2147483647; width: 280px; background: rgba(18,20,28,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.45); overflow: hidden; }
    .ea-panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; background: rgba(255,174,0,0.07); border-bottom: 1px solid rgba(255,174,0,0.35); }
    .ea-panel-title { font-size: 13px; font-weight: 600; }
    .ea-panel-close { background: transparent; border: none; color: #ddd; font-size: 18px; cursor: pointer; line-height: 1; }
    .ea-panel-close:hover { color: #fff; }
    /* Donate (gift) icon in the panel header */
    .ea-panel-donate { background: transparent; border: none; color: #ffd36b; font-size: 18px; cursor: pointer; line-height: 1; text-decoration: none; display:inline-flex; align-items:center; justify-content:center; }
    .ea-panel-donate:hover { color: #fff; text-shadow: 0 0 6px rgba(255,174,0,0.55); }
    .ea-panel-body { padding: 12px; display:flex; flex-direction:column; gap:8px; }
    .ea-kv { display:flex; align-items:center; justify-content:space-between; font-size: 12px; color: #ccc; }
    .ea-progress { position: relative; width: 100%; height: 12px; background: #2a2f3d; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }
    .ea-progress-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg, #ffae00, #ffd36b); box-shadow: inset 0 0 6px rgba(0,0,0,0.4); transition: width 220ms ease; }
    .ea-progress-label { text-align: right; font-size: 11px; color: #bbb; }
  `),typeof GM_registerMenuCommand=="function"&&GM_registerMenuCommand("Toggle Debug Logs",()=>{let t=!GM_getValue(Z,!1);GM_setValue(Z,t),alert(`Erepublik Anniversary: Debug logs ${t?"enabled":"disabled"}.`)});try{if(ke(),!W){console.warn("EA: Not authorized to run this script on this account."),$("Not authorized for this account. Contact maintainer if this is unexpected.",{kind:"error",ttl:5e3,dedupeFor:1e4});return}Le(),Me()}catch(t){console.error("EA init failed",t)}}function ke(){if(![/^\/?$/i,/^\/en\/?$/i,/^\/en\/(?:citizen|military|economy|politics)/i].some(o=>o.test(location.pathname)))return;let e=document.createElement("div");e.className="ea-badge",e.title="Erepublik Anniversary Userscript (Boilerplate)",e.style.position="fixed",e.style.zIndex="2147483647",e.style.bottom="12px",e.style.right="12px";let a=document.createElement("span");a.textContent="ðŸŽ‚ Anniversary Mode",e.appendChild(a);let n=document.createElement("span");n.className="ea-auth-indicator",n.textContent=W?"âœ…":"â›”",n.title=W?"Authorized":"Not authorized",e.appendChild(n),document.body.appendChild(e),e.style.cursor="pointer",e.addEventListener("click",()=>Ne()),_("Anniversary badge mounted")}var Q={container:null,lastShown:new Map};function Ee(){if(Q.container&&document.body.contains(Q.container))return Q.container;let t=document.createElement("div");return t.className="ea-toast-container",document.body.appendChild(t),Q.container=t,t}function $(t,{kind:e="warn",ttl:a=4500,dedupeFor:n=5*6e4}={}){try{let o=Date.now(),u=Q.lastShown.get(t)||0;if(o-u<n)return;Q.lastShown.set(t,o);let d=Ee(),g=document.createElement("div");g.className=`ea-toast ${e}`;let E=document.createElement("span");E.textContent=t,g.appendChild(E);let s=document.createElement("button");s.className="ea-close",s.type="button",s.setAttribute("aria-label","Close"),s.textContent="Ã—",g.appendChild(s);let i=!1,f=()=>{if(!i){i=!0;try{clearTimeout(w)}catch{}g.style.transition="opacity 250ms ease",g.style.opacity="0",setTimeout(()=>g.remove(),260)}};s.addEventListener("click",f),d.appendChild(g);let w=setTimeout(f,a)}catch{try{alert(t)}catch{}}}var p={el:null};function Se(){try{let t=window&&window.status&&window.status.inventory||{},e=Number(t.miles),a=Number(t.distanceNeeded);return{miles:Number.isFinite(e)?e:0,needed:Number.isFinite(a)?a:0}}catch{return{miles:0,needed:0}}}function pe(t){try{return new Intl.NumberFormat(void 0).format(t)}catch{return String(t)}}function Ie(){if(p.el&&document.body.contains(p.el))return p.el;let t=document.createElement("div");t.className="ea-panel";let e=document.createElement("div");e.className="ea-panel-header";let a=document.createElement("div");a.className="ea-panel-title",a.textContent=`Anniversary Progress v${fe}`;let n=document.createElement("div");n.style.display="inline-flex",n.style.alignItems="center",n.style.gap="10px";let o=document.createElement("a");o.className="ea-panel-donate",o.href="https://www.erepublik.com/en/economy/donate-money/4690052",o.target="_blank",o.rel="noopener noreferrer",o.title="Donate (opens in a new tab)",o.setAttribute("aria-label","Donate"),o.textContent="ðŸŽ";let u=document.createElement("button");u.className="ea-panel-close",u.type="button",u.setAttribute("aria-label","Close"),u.textContent="Ã—",n.appendChild(o),n.appendChild(u),e.appendChild(a),e.appendChild(n);let d=document.createElement("div");d.className="ea-panel-body";let g=document.createElement("div");g.className="ea-kv";let E=document.createElement("div");E.textContent="Distance covered";let s=document.createElement("div");s.className="ea-progress-label",g.appendChild(E),g.appendChild(s);let i=document.createElement("div");i.className="ea-progress";let f=document.createElement("div");f.className="ea-progress-bar",i.appendChild(f);let w=document.createElement("div");w.style.marginTop="6px",w.style.borderTop="1px solid rgba(255,255,255,0.08)",w.style.paddingTop="8px";let A=document.createElement("div");A.className="ea-kv";let D=document.createElement("div");D.textContent="Travel automation";let C=document.createElement("div");C.className="ea-progress-label",A.appendChild(D),A.appendChild(C);let S=document.createElement("div");S.style.display="flex",S.style.flexDirection="column",S.style.alignItems="stretch",S.style.gap="6px",S.style.margin="6px 0 2px";let z=document.createElement("div");z.style.display="flex",z.style.alignItems="center",z.style.gap="8px";let F=document.createElement("div");F.style.flex="0 0 auto",F.style.fontSize="12px",F.style.opacity="0.85",F.textContent="Pay with";let I=document.createElement("select");I.style.flex="0 0 auto",I.style.padding="3px 6px",I.style.borderRadius="6px",I.style.border="1px solid rgba(255,255,255,0.25)",I.style.background="rgba(255,255,255,0.06)",I.style.color="#fff";let y=document.createElement("option");y.value="ticketOnly",y.textContent="ticket";let q=document.createElement("option");q.value="preferCurrency",q.textContent="cc",I.appendChild(y),I.appendChild(q);try{I.value=ge()}catch{}I.addEventListener("change",()=>{let k=I.value;Te(k)}),z.appendChild(F),z.appendChild(I);let l=document.createElement("select");l.style.flex="0 0 auto",l.style.width="100%";let P=document.createElement("span");P.textContent="â†”",P.style.opacity="0.6",P.style.display="none";let c=document.createElement("select");c.style.flex="0 0 auto",c.style.width="100%";let h=document.createElement("button");h.type="button",h.textContent="Reload destinations",h.title="Reload destinations",h.style.flex="0 0 auto",h.style.padding="4px 8px",h.style.borderRadius="6px",h.style.border="1px solid rgba(255,255,255,0.25)",h.style.background="rgba(255,255,255,0.06)",h.style.color="#fff",h.style.cursor="pointer",S.appendChild(z),S.appendChild(l),S.appendChild(P),S.appendChild(c);let N=document.createElement("div");N.style.display="flex",N.style.gap="8px",N.style.alignItems="center",N.style.marginTop="2px";let v=document.createElement("button");v.type="button",v.textContent="Start",v.style.flex="0 0 auto",v.style.padding="6px 10px",v.style.borderRadius="6px",v.style.border="1px solid var(--ea-accent)",v.style.background="rgba(255,174,0,0.08)",v.style.color="#fff",v.style.cursor="pointer",N.appendChild(h),N.appendChild(v);let G=document.createElement("div");G.style.fontSize="11px",G.style.color="#bbb",G.style.marginTop="6px";let H=document.createElement("div");H.style.fontSize="11px",H.style.color="#bbb",w.appendChild(A),w.appendChild(S),w.appendChild(N),w.appendChild(G),w.appendChild(H),d.appendChild(g),d.appendChild(i),d.appendChild(w),t.appendChild(e),t.appendChild(d),document.body.appendChild(t);let ne=k=>{k.key==="Escape"&&te()};document.addEventListener("keydown",ne),u.addEventListener("click",()=>te()),p.el=t,p.refs={right:s,bar:f,travelState:C,toggleBtn:v,statusLine:G,nextLine:H,selA:l,selB:c,refreshBtn:h},p.cleanup=()=>{document.removeEventListener("keydown",ne)};try{s.textContent="Refreshingâ€¦"}catch{}ee(),me();try{let k=ye(),ae="ea:travel:dstA",oe="ea:travel:dstB",re=r=>{let b=document.createElement("option");return b.value=String(r.id),b.textContent=r._label||`${r.name} (${r._countryName||r.countryId})`,b.dataset.countryId=String(r.countryId),b},se=r=>{for(;r.firstChild;)r.removeChild(r.firstChild)},ie=r=>{try{let b=localStorage.getItem(r);return b?Number(b):null}catch{return null}},le=(r,b)=>{try{localStorage.setItem(r,String(b))}catch{}},X=()=>{let r=Number(l.value||0),b=Number(c.value||0),L=l.selectedOptions[0],O=c.selectedOptions[0],M=L?Number(L.dataset.countryId):0,R=O?Number(O.dataset.countryId):0,j=L?L.textContent:"",T=O?O.textContent:"",x=[];r&&M&&x.push({regionId:r,countryId:M,label:j}),b&&R&&x.push({regionId:b,countryId:R,label:T});let U=x.length===2?[x[0],x[1]]:x.length===1?[x[0]]:[];k.setTargets(U);let V=k.getState(),m=U.length>=2;v.disabled=!V.running&&!m};async function xe({signal:r}={}){let b=he();if(!b)throw new Error("Missing CSRF token");let L=m=>{try{let K=document.cookie.match(new RegExp(`(?:^|; )${m}=([^;]*)`));return K?decodeURIComponent(K[1]):""}catch{return""}},O=erepublik.citizen.regionLocationId,M=new URLSearchParams;M.set("_token",String(b)),M.set("holdingId","0"),M.set("battleId","0"),M.set("regionId",String(O||3));let R=await fetch("/en/main/travelData",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:M,signal:r}),j=await R.json();if(!R.ok||!j)throw new Error(`travelData failed: HTTP ${R.status}`);let T=j.countries||{},x=j.regions||{},U={};Object.values(T).forEach(m=>{m&&m.id&&(U[m.id]=m.name)});let V=Object.values(x).filter(m=>m&&m.id&&m.name&&m.countryId).map(m=>({id:Number(m.id),name:String(m.name),countryId:Number(m.countryId),_countryName:U[Number(m.countryId)]||`#${m.countryId}`})).sort((m,K)=>m.name.localeCompare(K.name));return V.forEach(m=>{m._label=`${m.name} (${m._countryName})`}),V}let ce=async()=>{try{l.disabled=c.disabled=h.disabled=!0,se(l),se(c);let r=T=>{let x=document.createElement("option");return x.value="",x.textContent=T,x};l.appendChild(r("Select region Aâ€¦")),c.appendChild(r("Select region Bâ€¦")),(await xe()).forEach(T=>{l.appendChild(re(T)),c.appendChild(re(T))});let L=ie(ae),O=ie(oe),M=(T,x)=>x&&[...T.options].find(V=>Number(V.value)===Number(x))?(T.value=String(x),!0):!1,R=M(l,L),j=M(c,O);if(R||(R=M(l,714)),j||(j=M(c,173)),l.value&&l.value===c.value){let T=[...c.options].find(x=>x.value&&x.value!==l.value);T&&(c.value=T.value)}X()}catch(r){_("Failed to populate travel selectors",r&&r.message?r.message:r),$("Failed to load travel destinations",{kind:"error"})}finally{l.disabled=c.disabled=!1,h.disabled=!1}};l.addEventListener("change",()=>{l.value&&le(ae,l.value),X()}),c.addEventListener("change",()=>{c.value&&le(oe,c.value),X()}),h.addEventListener("click",()=>ce());let de=()=>{let r=k.getState();C.textContent=r.running?"Running":"Stopped";let b=!!l.value&&!!c.value&&l.value!==c.value;if(v.textContent=r.running?"Stop":"Start",v.disabled=r.running?!1:!b,G.textContent=`Hops: ${r.hops} | Last: ${r.lastMessage||"â€”"}`,r.running&&r.nextAt){let L=Math.max(0,r.nextAt-Date.now());H.textContent=`Next hop to ${r.nextLabel} in ${be(Math.ceil(L/1e3))}`}else H.textContent=`Next hop: ${r.nextLabel}`};k.onChange(de),v.addEventListener("click",()=>{if(k.getState().running){k.stop();return}if(!(!!l.value&&!!c.value&&l.value!==c.value)){$("Pick two different regions first",{kind:"warn"});return}k.start()}),de(),ce()}catch(k){_("Travel UI failed to wire",k&&k.message?k.message:k)}return t}function ee(){if(!p.el||!p.refs)return;let{miles:t,needed:e}=Se(),a=Math.max(0,e),n=Math.max(0,t),o=a>0?Math.max(0,Math.min(100,n/a*100)):0;try{p.refs.bar.style.width=`${o}%`}catch{}try{p.refs.right.textContent=`${pe(n)} / ${pe(a)} miles (${Math.floor(o)}%)`}catch{}}async function _e({signal:t}={}){let a=await fetch("/en/main/anniversaryQuestData",{method:"GET",headers:{accept:"application/json, text/javascript, */*; q=0.01","x-requested-with":"XMLHttpRequest"},credentials:"same-origin",cache:"no-store",signal:t}),n=null;try{n=await a.json()}catch{}if(!a.ok||!n){let g=n&&(n.message||n.error)||`HTTP ${a.status}`,E=new Error(`anniversaryQuestData failed: ${g}`);throw E.status=a.status,E}let o=n&&n.status&&n.status.inventory||{},u=Number(o.miles),d=Number(o.distanceNeeded);return{miles:Number.isFinite(u)?u:0,needed:Number.isFinite(d)?d:0}}async function me(){try{p.abortCtrl&&p.abortCtrl.abort()}catch{}let t=new AbortController;p.abortCtrl=t;try{p.refs&&p.refs.right&&(p.refs.right.textContent="Refreshingâ€¦")}catch{}try{let e=await _e({signal:t.signal});try{let a=window||{};a.status=a.status||{},a.status.inventory=a.status.inventory||{},a.status.inventory.miles=e.miles,a.status.inventory.distanceNeeded=e.needed}catch{}p.el&&document.body.contains(p.el)&&ee()}catch(e){_("Refresh failed",e&&e.message?e.message:e),$("Failed to refresh Anniversary data. Showing cached values.",{kind:"warn"}),p.el&&document.body.contains(p.el)&&ee()}finally{p.abortCtrl=null}}function te(){if(p.el){try{try{p.abortCtrl&&p.abortCtrl.abort()}catch{}p.cleanup&&p.cleanup()}catch{}p.el.remove(),p.el=null}}function Ne(){p.el&&document.body.contains(p.el)?te():Ie()}function he(){let t=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(t)return t;try{let e=document.querySelector('meta[name="csrf-token"], meta[name="csrf_token"], input[name="_token"]');if(e)return e.content||e.value||null}catch{}return null}function ge(){let t="ea:travel:method";try{let e=localStorage.getItem(t);return e==="ticketOnly"||e==="preferCurrency"?e:"preferCurrency"}catch{return"preferCurrency"}}function Te(t){let e="ea:travel:method",a=t==="preferCurrency"?"preferCurrency":"ticketOnly";try{localStorage.setItem(e,a)}catch{}return a}async function Ae(t,e){if(!B("travel"))throw new Error("Not authorized");let a=he();if(!a)throw new Error("Missing CSRF token");let n=new URLSearchParams;n.set("check","moveAction"),n.set("_token",String(a)),n.set("travelMethod",ge()),n.set("inRegionId",String(t)),n.set("toCountryId",String(e));let o=await fetch("/en/main/travel",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:n}),u=null;try{u=await o.json()}catch{}if(!o.ok){let d=u&&(u.message||u.error)||`HTTP ${o.status}`,g=new Error(d);throw g.status=o.status,g}return u||{message:"OK"}}var Y=null;function ye(){if(Y)return Y;let t=new Set,e=()=>{try{t.forEach(s=>s())}catch{}},a=[],n={running:!1,index:0,hops:0,nextAt:null,lastMessage:""},o=null,u=()=>{o&&(clearTimeout(o),o=null)},d=(s=4e3,i=6e3)=>{let f=Math.floor(s+Math.random()*Math.max(0,i-s));n.nextAt=Date.now()+f,u(),o=setTimeout(g,f),e()},g=async()=>{if(!n.running)return;if(!B("travel step")){E.stop();return}if(!a||a.length===0){n.lastMessage="No destinations selected",e(),E.stop();return}let s=a[n.index%a.length];try{n.lastMessage=`Flying to ${s.label}â€¦`,e();let i=await Ae(s.regionId,s.countryId);n.hops+=1,n.index=(n.index+1)%a.length;try{await me()}catch{}let f=i&&(i.message||i.success)?String(i.message||i.success):"OK";n.lastMessage=`OK â†’ ${f}`,e(),d(4e3,6e3)}catch(i){let f=i&&i.status?Number(i.status):0,w=i&&i.message?i.message:"Error";n.lastMessage=`Error (${f||"n/a"}): ${w}`,$(`Travel failed${f?` (${f})`:""}: ${w}`,{kind:"error",ttl:5e3}),e(),f===429?d(8e3,12e3):d(5e3,7e3)}},E={start(){n.running||B("travel start")&&(n.running=!0,n.lastMessage="Startingâ€¦",$("Travel automation started",{kind:"info"}),d(250,750),e())},stop(){n.running&&(n.running=!1,u(),n.nextAt=null,$("Travel automation stopped",{kind:"warn"}),e())},setTargets(s){try{a=(Array.isArray(s)?s.filter(Boolean):[]).map(f=>({regionId:Number(f.regionId),countryId:Number(f.countryId),label:String(f.label||"")})),n.index=0,e()}catch{}},getState(){let s=a&&a.length?a[n.index%a.length]:{label:"â€”"};return{...n,nextLabel:s.label}},onChange(s){return typeof s=="function"&&t.add(s),()=>t.delete(s)}};return Y=E,E}function Me(){try{window.EA_Travel=ye()}catch{}}async function $e(t){if(!B("open city"))throw new Error("Not authorized");if(!Number.isFinite(Number(t)))throw new Error("Invalid nodeId");let e=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(!e)throw new Error("Missing csrfToken on page");let a=new URLSearchParams;a.set("nodeId",String(t)),a.set("_token",String(e));let n=await fetch("/en/main/map-rewards-unlock",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:a}),o=null;try{o=await n.json()}catch{}if(!n.ok){let u=o&&(o.message||o.error)||`HTTP ${n.status}`,d=new Error(u);throw d.status=n.status,d}return o||{message:"OK"}}function be(t){let e=Math.max(0,Math.floor(t)),a=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60),u=e%60,d=[];return a&&d.push(`${a}d`),n&&d.push(`${n}h`),o&&d.length<2&&d.push(`${o}m`),d.length||d.push(`${u}s`),d.slice(0,2).join(" ")}function ze(t){try{return new Date(t).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}catch{let a=new Date(t),n=String(a.getHours()).padStart(2,"0"),o=String(a.getMinutes()).padStart(2,"0");return`${n}:${o}`}}var J=new Set([4690052,4571252,2707490,1714685,4407464]),W=!1;function Le(){if(!B("quest poller init"))return;let t="/en/main/anniversaryQuestData",e=!1,a=0,n=null,o=null,u=!1,d=new Map,g=()=>{let s=Date.now();for(let[i,f]of d)s-f>2*6e4&&d.delete(i)},E=async()=>{if(B("quest poll")&&!e){e=!0;try{let s=await fetch(t,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);let i=await s.json(),f=i&&i.status&&Array.isArray(i.status.queue)?i.status.queue:[],w=f.length>=3;if(_("QuestData queue size:",f.length),w){let A="No empty slots";try{let D=f.map(C=>Number(C&&C.remainingTime)).filter(C=>Number.isFinite(C)&&C>0);if(D.length>0){let C=Math.min(...D),S=Math.max(0,Math.ceil(C/60)*60),z=Date.now()+S*1e3;A+=` â€” next in ${be(S)} (at ${ze(z)})`}}catch{}$(A,{kind:"warn",ttl:4e3,dedupeFor:59e3})}else try{let A=i&&i.status&&i.status.progress||{},D=Array.isArray(i&&i.neighbors)?i.neighbors:[],C=i&&i.cities||{},S=new Set(f.map(y=>y&&y.nodeId).filter(Boolean)),z=new Set(Object.values(A).filter(y=>y&&(y.nodeStatus==="unclaimed"||y.nodeStatus==="claimed")).map(y=>y.nodeId)),F=new Set(Object.values(A).filter(y=>y&&y.nodeStatus==="unlocking").map(y=>y.nodeId)),I=new Set([...z,...S,...F]);if(I.size>0&&D.length>0){let y=new Set;D.forEach(l=>{!l||typeof l.nodeId!="number"||typeof l.neighborId!="number"||(I.has(l.nodeId)&&y.add(l.neighborId),I.has(l.neighborId)&&y.add(l.nodeId))});let q=[...y].filter(l=>!z.has(l)).filter(l=>!S.has(l)).filter(l=>!F.has(l));if(q.length>0){let P=`Available cities to open: ${q.map(c=>{let h=C&&C[c];return h&&h.name?h.name:String(c)}).join(", ")}`;if($(P,{kind:"info",ttl:5e4,dedupeFor:5e4}),g(),!u&&B("auto open city")){let c=q.find(h=>!d.has(h));if(typeof c=="number"){u=!0,d.set(c,Date.now());let h=C&&C[c]&&C[c].name||String(c);$e(c).then(N=>{let v=N&&N.message||"Successfully started node unlock";$(`Added to queue: ${h} (#${c}) â€” ${v}`,{kind:"info",ttl:8e3,dedupeFor:4e3})}).catch(N=>{let v=N&&N.message?N.message:"Failed to add city to queue";$(`Failed to add ${h} (#${c}) â€” ${v}`,{kind:"error",ttl:9e3,dedupeFor:2e3})}).finally(()=>{u=!1,setTimeout(()=>{E()},150)})}}}}}catch(A){_("Next cities suggestion failed",A)}o=w,a=0}catch(s){a+=1,_("QuestData poll failed",s),a===3&&$("Anniversary data polling temporarily failing",{kind:"error",ttl:5e3,dedupeFor:15*6e4})}finally{e=!1}}};E(),n=setInterval(E,6e4),window.addEventListener("beforeunload",()=>{n&&clearInterval(n)},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ue,{once:!0}):ue();})();
