// ==UserScript==
// @name         Erepublik Anniversary Script
// @namespace    https://github.com/driversti/ereplab
// @version      1.1.3
// @description  A userscript to celebrate and enhance the Erepublik Anniversary event.
// @author       driversti
// @match        https://www.erepublik.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=erepublik.com
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @run-at       document-end
// @license      proprietary
// @downloadURL  https://github.com/driversti/erepublik-scripts/raw/refs/heads/main/erepublik-anniversary.user.js
// @updateURL  https://github.com/driversti/erepublik-scripts/raw/refs/heads/main/erepublik-anniversary.user.js
// ==/UserScript==


(()=>{var X="ea:debug",S=(...t)=>{try{typeof GM_getValue=="function"&&GM_getValue(X,!1)&&console.log("[EA]",...t)}catch{}};function fe(){try{if(typeof window!="undefined"&&window.erepublik&&window.erepublik.citizen){let t=window.erepublik.citizen.citizenId;if(t!=null){let e=Number(t);if(Number.isFinite(e)&&e>0)return S("Detected citizenId from window.erepublik"),e}}if(typeof unsafeWindow!="undefined"&&unsafeWindow.erepublik&&unsafeWindow.erepublik.citizen){let t=unsafeWindow.erepublik.citizen.citizenId;if(t!=null){let e=Number(t);if(Number.isFinite(e)&&e>0)return S("Detected citizenId from unsafeWindow.erepublik"),e}}}catch{}return S("Citizen ID not available via in-page globals; DOM detection is disabled"),null}function me(){if(!(W&&W.size))return S("Authorization allowlist is empty; denying access"),!1;let t=fe();if(!t)return S("Could not determine citizen ID; denying access"),!1;let e=W.has(t);return e||S(`Citizen ${t} is not in allowlist; denying access`),e}function he(t){if(typeof GM_addStyle=="function")try{GM_addStyle(t);return}catch{}let e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}function q(t){return Q?!0:(S(`Blocked action${t?`: ${t}`:""} â€” not authorized`),!1)}function se(){if(S("Booting Erepublik Anniversary userscript"),!/erepublik\.com$/i.test(location.hostname)){S("Not on erepublik.com, aborting");return}Q=!!me(),he(`
    :root { --ea-accent: #ffae00; }
    .ea-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:10px; background:#1b1f2a; color:#fff; border:1px solid var(--ea-accent); font-size:12px; }
    .ea-auth-indicator { margin-left: 8px; font-size: 14px; line-height: 1; }

    /* Toasts */
    .ea-toast-container { position: fixed; right: 12px; bottom: 60px; z-index: 2147483647; display: flex; flex-direction: column; gap: 8px; }
    .ea-toast { position: relative; min-width: 200px; max-width: 360px; background: rgba(27,31,42,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 8px; padding: 10px 28px 10px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); font-size: 13px; line-height: 1.35; }
    .ea-toast.info { border-color: #4aa3ff; }
    .ea-toast.warn { border-color: #ffae00; }
    .ea-toast.error { border-color: #ff5a5a; }
    .ea-toast .ea-close { position: absolute; top: 4px; right: 6px; width: 20px; height: 20px; border: none; background: transparent; color: #ccc; cursor: pointer; font-size: 16px; line-height: 20px; padding: 0; }
    .ea-toast .ea-close:hover { color: #fff; }

    /* Mini panel for Anniversary progress */
    .ea-panel { position: fixed; right: 12px; bottom: 48px; z-index: 2147483647; width: 280px; background: rgba(18,20,28,0.98); color: #fff; border: 1px solid var(--ea-accent); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.45); overflow: hidden; }
    .ea-panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; background: rgba(255,174,0,0.07); border-bottom: 1px solid rgba(255,174,0,0.35); }
    .ea-panel-title { font-size: 13px; font-weight: 600; }
    .ea-panel-close { background: transparent; border: none; color: #ddd; font-size: 18px; cursor: pointer; line-height: 1; }
    .ea-panel-close:hover { color: #fff; }
    /* Donate (gift) icon in the panel header */
    .ea-panel-donate { background: transparent; border: none; color: #ffd36b; font-size: 18px; cursor: pointer; line-height: 1; text-decoration: none; display:inline-flex; align-items:center; justify-content:center; }
    .ea-panel-donate:hover { color: #fff; text-shadow: 0 0 6px rgba(255,174,0,0.55); }
    .ea-panel-body { padding: 12px; display:flex; flex-direction:column; gap:8px; }
    .ea-kv { display:flex; align-items:center; justify-content:space-between; font-size: 12px; color: #ccc; }
    .ea-progress { position: relative; width: 100%; height: 12px; background: #2a2f3d; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }
    .ea-progress-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg, #ffae00, #ffd36b); box-shadow: inset 0 0 6px rgba(0,0,0,0.4); transition: width 220ms ease; }
    .ea-progress-label { text-align: right; font-size: 11px; color: #bbb; }
  `),typeof GM_registerMenuCommand=="function"&&GM_registerMenuCommand("Toggle Debug Logs",()=>{let t=!GM_getValue(X,!1);GM_setValue(X,t),alert(`Erepublik Anniversary: Debug logs ${t?"enabled":"disabled"}.`)});try{if(ge(),!Q){console.warn("EA: Not authorized to run this script on this account."),A("Not authorized for this account. Contact maintainer if this is unexpected.",{kind:"error",ttl:5e3,dedupeFor:1e4});return}Ie(),ke()}catch(t){console.error("EA init failed",t)}}function ge(){if(![/^\/?$/i,/^\/en\/?$/i,/^\/en\/(?:citizen|military|economy|politics)/i].some(o=>o.test(location.pathname)))return;let e=document.createElement("div");e.className="ea-badge",e.title="Erepublik Anniversary Userscript (Boilerplate)",e.style.position="fixed",e.style.zIndex="2147483647",e.style.bottom="12px",e.style.right="12px";let a=document.createElement("span");a.textContent="ðŸŽ‚ Anniversary Mode",e.appendChild(a);let n=document.createElement("span");n.className="ea-auth-indicator",n.textContent=Q?"âœ…":"â›”",n.title=Q?"Authorized":"Not authorized",e.appendChild(n),document.body.appendChild(e),e.style.cursor="pointer",e.addEventListener("click",()=>ve()),S("Anniversary badge mounted")}var H={container:null,lastShown:new Map};function ye(){if(H.container&&document.body.contains(H.container))return H.container;let t=document.createElement("div");return t.className="ea-toast-container",document.body.appendChild(t),H.container=t,t}function A(t,{kind:e="warn",ttl:a=4500,dedupeFor:n=5*6e4}={}){try{let o=Date.now(),d=H.lastShown.get(t)||0;if(o-d<n)return;H.lastShown.set(t,o);let l=ye(),y=document.createElement("div");y.className=`ea-toast ${e}`;let E=document.createElement("span");E.textContent=t,y.appendChild(E);let s=document.createElement("button");s.className="ea-close",s.type="button",s.setAttribute("aria-label","Close"),s.textContent="Ã—",y.appendChild(s);let i=!1,m=()=>{if(!i){i=!0;try{clearTimeout(v)}catch{}y.style.transition="opacity 250ms ease",y.style.opacity="0",setTimeout(()=>y.remove(),260)}};s.addEventListener("click",m),l.appendChild(y);let v=setTimeout(m,a)}catch{try{alert(t)}catch{}}}var p={el:null};function be(){try{let t=window&&window.status&&window.status.inventory||{},e=Number(t.miles),a=Number(t.distanceNeeded);return{miles:Number.isFinite(e)?e:0,needed:Number.isFinite(a)?a:0}}catch{return{miles:0,needed:0}}}function ie(t){try{return new Intl.NumberFormat(void 0).format(t)}catch{return String(t)}}function xe(){if(p.el&&document.body.contains(p.el))return p.el;let t=document.createElement("div");t.className="ea-panel";let e=document.createElement("div");e.className="ea-panel-header";let a=document.createElement("div");a.className="ea-panel-title",a.textContent="Anniversary Progress";let n=document.createElement("div");n.style.display="inline-flex",n.style.alignItems="center",n.style.gap="10px";let o=document.createElement("a");o.className="ea-panel-donate",o.href="https://www.erepublik.com/en/economy/donate-money/4690052",o.target="_blank",o.rel="noopener noreferrer",o.title="Donate (opens in a new tab)",o.setAttribute("aria-label","Donate"),o.textContent="ðŸŽ";let d=document.createElement("button");d.className="ea-panel-close",d.type="button",d.setAttribute("aria-label","Close"),d.textContent="Ã—",n.appendChild(o),n.appendChild(d),e.appendChild(a),e.appendChild(n);let l=document.createElement("div");l.className="ea-panel-body";let y=document.createElement("div");y.className="ea-kv";let E=document.createElement("div");E.textContent="Distance covered";let s=document.createElement("div");s.className="ea-progress-label",y.appendChild(E),y.appendChild(s);let i=document.createElement("div");i.className="ea-progress";let m=document.createElement("div");m.className="ea-progress-bar",i.appendChild(m);let v=document.createElement("div");v.style.marginTop="6px",v.style.borderTop="1px solid rgba(255,255,255,0.08)",v.style.paddingTop="8px";let T=document.createElement("div");T.className="ea-kv";let L=document.createElement("div");L.textContent="Travel automation";let C=document.createElement("div");C.className="ea-progress-label",T.appendChild(L),T.appendChild(C);let I=document.createElement("div");I.style.display="flex",I.style.flexDirection="column",I.style.alignItems="stretch",I.style.gap="6px",I.style.margin="6px 0 2px";let f=document.createElement("select");f.style.flex="0 0 auto",f.style.width="100%";let j=document.createElement("span");j.textContent="â†”",j.style.opacity="0.6",j.style.display="none";let h=document.createElement("select");h.style.flex="0 0 auto",h.style.width="100%";let c=document.createElement("button");c.type="button",c.textContent="Reload destinations",c.title="Reload destinations",c.style.flex="0 0 auto",c.style.padding="4px 8px",c.style.borderRadius="6px",c.style.border="1px solid rgba(255,255,255,0.25)",c.style.background="rgba(255,255,255,0.06)",c.style.color="#fff",c.style.cursor="pointer",I.appendChild(f),I.appendChild(j),I.appendChild(h);let M=document.createElement("div");M.style.display="flex",M.style.gap="8px",M.style.alignItems="center",M.style.marginTop="2px";let u=document.createElement("button");u.type="button",u.textContent="Start",u.style.flex="0 0 auto",u.style.padding="6px 10px",u.style.borderRadius="6px",u.style.border="1px solid var(--ea-accent)",u.style.background="rgba(255,174,0,0.08)",u.style.color="#fff",u.style.cursor="pointer",M.appendChild(c),M.appendChild(u);let F=document.createElement("div");F.style.fontSize="11px",F.style.color="#bbb",F.style.marginTop="6px";let k=document.createElement("div");k.style.fontSize="11px",k.style.color="#bbb",v.appendChild(T),v.appendChild(I),v.appendChild(M),v.appendChild(F),v.appendChild(k),l.appendChild(y),l.appendChild(i),l.appendChild(v),t.appendChild(e),t.appendChild(l),document.body.appendChild(t);let $=b=>{b.key==="Escape"&&J()};document.addEventListener("keydown",$),d.addEventListener("click",()=>J()),p.el=t,p.refs={right:s,bar:m,travelState:C,toggleBtn:u,statusLine:F,nextLine:k,selA:f,selB:h,refreshBtn:c},p.cleanup=()=>{document.removeEventListener("keydown",$)};try{s.textContent="Refreshingâ€¦"}catch{}Y(),le();try{let b=de(),B="ea:travel:dstA",Z="ea:travel:dstB",ee=r=>{let x=document.createElement("option");return x.value=String(r.id),x.textContent=r._label||`${r.name} (${r._countryName||r.countryId})`,x.dataset.countryId=String(r.countryId),x},te=r=>{for(;r.firstChild;)r.removeChild(r.firstChild)},ne=r=>{try{let x=localStorage.getItem(r);return x?Number(x):null}catch{return null}},ae=(r,x)=>{try{localStorage.setItem(r,String(x))}catch{}},K=()=>{let r=Number(f.value||0),x=Number(h.value||0),z=f.selectedOptions[0],R=h.selectedOptions[0],_=z?Number(z.dataset.countryId):0,D=R?Number(R.dataset.countryId):0,O=z?z.textContent:"",N=R?R.textContent:"",w=[];r&&_&&w.push({regionId:r,countryId:_,label:O}),x&&D&&w.push({regionId:x,countryId:D,label:N});let P=w.length===2?[w[0],w[1]]:w.length===1?[w[0]]:[];b.setTargets(P);let G=b.getState(),g=P.length>=2;u.disabled=!G.running&&!g};async function pe({signal:r}={}){let x=ce();if(!x)throw new Error("Missing CSRF token");let z=g=>{try{let U=document.cookie.match(new RegExp(`(?:^|; )${g}=([^;]*)`));return U?decodeURIComponent(U[1]):""}catch{return""}},R=erepublik.citizen.regionLocationId,_=new URLSearchParams;_.set("_token",String(x)),_.set("holdingId","0"),_.set("battleId","0"),_.set("regionId",String(R||3));let D=await fetch("/en/main/travelData",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:_,signal:r}),O=await D.json();if(!D.ok||!O)throw new Error(`travelData failed: HTTP ${D.status}`);let N=O.countries||{},w=O.regions||{},P={};Object.values(N).forEach(g=>{g&&g.id&&(P[g.id]=g.name)});let G=Object.values(w).filter(g=>g&&g.id&&g.name&&g.countryId).map(g=>({id:Number(g.id),name:String(g.name),countryId:Number(g.countryId),_countryName:P[Number(g.countryId)]||`#${g.countryId}`})).sort((g,U)=>g.name.localeCompare(U.name));return G.forEach(g=>{g._label=`${g.name} (${g._countryName})`}),G}let oe=async()=>{try{f.disabled=h.disabled=c.disabled=!0,te(f),te(h);let r=N=>{let w=document.createElement("option");return w.value="",w.textContent=N,w};f.appendChild(r("Select region Aâ€¦")),h.appendChild(r("Select region Bâ€¦")),(await pe()).forEach(N=>{f.appendChild(ee(N)),h.appendChild(ee(N))});let z=ne(B),R=ne(Z),_=(N,w)=>w&&[...N.options].find(G=>Number(G.value)===Number(w))?(N.value=String(w),!0):!1,D=_(f,z),O=_(h,R);if(D||(D=_(f,714)),O||(O=_(h,173)),f.value&&f.value===h.value){let N=[...h.options].find(w=>w.value&&w.value!==f.value);N&&(h.value=N.value)}K()}catch(r){S("Failed to populate travel selectors",r&&r.message?r.message:r),A("Failed to load travel destinations",{kind:"error"})}finally{f.disabled=h.disabled=!1,c.disabled=!1}};f.addEventListener("change",()=>{f.value&&ae(B,f.value),K()}),h.addEventListener("change",()=>{h.value&&ae(Z,h.value),K()}),c.addEventListener("click",()=>oe());let re=()=>{let r=b.getState();C.textContent=r.running?"Running":"Stopped";let x=!!f.value&&!!h.value&&f.value!==h.value;if(u.textContent=r.running?"Stop":"Start",u.disabled=r.running?!1:!x,F.textContent=`Hops: ${r.hops} | Last: ${r.lastMessage||"â€”"}`,r.running&&r.nextAt){let z=Math.max(0,r.nextAt-Date.now());k.textContent=`Next hop to ${r.nextLabel} in ${ue(Math.ceil(z/1e3))}`}else k.textContent=`Next hop: ${r.nextLabel}`};b.onChange(re),u.addEventListener("click",()=>{if(b.getState().running){b.stop();return}if(!(!!f.value&&!!h.value&&f.value!==h.value)){A("Pick two different regions first",{kind:"warn"});return}b.start()}),re(),oe()}catch(b){S("Travel UI failed to wire",b&&b.message?b.message:b)}return t}function Y(){if(!p.el||!p.refs)return;let{miles:t,needed:e}=be(),a=Math.max(0,e),n=Math.max(0,t),o=a>0?Math.max(0,Math.min(100,n/a*100)):0;try{p.refs.bar.style.width=`${o}%`}catch{}try{p.refs.right.textContent=`${ie(n)} / ${ie(a)} miles (${Math.floor(o)}%)`}catch{}}async function we({signal:t}={}){let a=await fetch("/en/main/anniversaryQuestData",{method:"GET",headers:{accept:"application/json, text/javascript, */*; q=0.01","x-requested-with":"XMLHttpRequest"},credentials:"same-origin",cache:"no-store",signal:t}),n=null;try{n=await a.json()}catch{}if(!a.ok||!n){let y=n&&(n.message||n.error)||`HTTP ${a.status}`,E=new Error(`anniversaryQuestData failed: ${y}`);throw E.status=a.status,E}let o=n&&n.status&&n.status.inventory||{},d=Number(o.miles),l=Number(o.distanceNeeded);return{miles:Number.isFinite(d)?d:0,needed:Number.isFinite(l)?l:0}}async function le(){try{p.abortCtrl&&p.abortCtrl.abort()}catch{}let t=new AbortController;p.abortCtrl=t;try{p.refs&&p.refs.right&&(p.refs.right.textContent="Refreshingâ€¦")}catch{}try{let e=await we({signal:t.signal});try{let a=window||{};a.status=a.status||{},a.status.inventory=a.status.inventory||{},a.status.inventory.miles=e.miles,a.status.inventory.distanceNeeded=e.needed}catch{}p.el&&document.body.contains(p.el)&&Y()}catch(e){S("Refresh failed",e&&e.message?e.message:e),A("Failed to refresh Anniversary data. Showing cached values.",{kind:"warn"}),p.el&&document.body.contains(p.el)&&Y()}finally{p.abortCtrl=null}}function J(){if(p.el){try{try{p.abortCtrl&&p.abortCtrl.abort()}catch{}p.cleanup&&p.cleanup()}catch{}p.el.remove(),p.el=null}}function ve(){p.el&&document.body.contains(p.el)?J():xe()}function ce(){let t=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(t)return t;try{let e=document.querySelector('meta[name="csrf-token"], meta[name="csrf_token"], input[name="_token"]');if(e)return e.content||e.value||null}catch{}return null}async function Ce(t,e){if(!q("travel"))throw new Error("Not authorized");let a=ce();if(!a)throw new Error("Missing CSRF token");let n=new URLSearchParams;n.set("check","moveAction"),n.set("_token",String(a)),n.set("travelMethod","ticketOnly"),n.set("inRegionId",String(t)),n.set("toCountryId",String(e));let o=await fetch("/en/main/travel",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:n}),d=null;try{d=await o.json()}catch{}if(!o.ok){let l=d&&(d.message||d.error)||`HTTP ${o.status}`,y=new Error(l);throw y.status=o.status,y}return d||{message:"OK"}}var V=null;function de(){if(V)return V;let t=new Set,e=()=>{try{t.forEach(s=>s())}catch{}},a=[],n={running:!1,index:0,hops:0,nextAt:null,lastMessage:""},o=null,d=()=>{o&&(clearTimeout(o),o=null)},l=(s=4e3,i=6e3)=>{let m=Math.floor(s+Math.random()*Math.max(0,i-s));n.nextAt=Date.now()+m,d(),o=setTimeout(y,m),e()},y=async()=>{if(!n.running)return;if(!q("travel step")){E.stop();return}if(!a||a.length===0){n.lastMessage="No destinations selected",e(),E.stop();return}let s=a[n.index%a.length];try{n.lastMessage=`Flying to ${s.label}â€¦`,e();let i=await Ce(s.regionId,s.countryId);n.hops+=1,n.index=(n.index+1)%a.length;try{await le()}catch{}let m=i&&(i.message||i.success)?String(i.message||i.success):"OK";n.lastMessage=`OK â†’ ${m}`,e(),l(4e3,6e3)}catch(i){let m=i&&i.status?Number(i.status):0,v=i&&i.message?i.message:"Error";n.lastMessage=`Error (${m||"n/a"}): ${v}`,A(`Travel failed${m?` (${m})`:""}: ${v}`,{kind:"error",ttl:5e3}),e(),m===429?l(8e3,12e3):l(5e3,7e3)}},E={start(){n.running||q("travel start")&&(n.running=!0,n.lastMessage="Startingâ€¦",A("Travel automation started",{kind:"info"}),l(250,750),e())},stop(){n.running&&(n.running=!1,d(),n.nextAt=null,A("Travel automation stopped",{kind:"warn"}),e())},setTargets(s){try{a=(Array.isArray(s)?s.filter(Boolean):[]).map(m=>({regionId:Number(m.regionId),countryId:Number(m.countryId),label:String(m.label||"")})),n.index=0,e()}catch{}},getState(){let s=a&&a.length?a[n.index%a.length]:{label:"â€”"};return{...n,nextLabel:s.label}},onChange(s){return typeof s=="function"&&t.add(s),()=>t.delete(s)}};return V=E,E}function ke(){try{window.EA_Travel=de()}catch{}}async function Ee(t){if(!q("open city"))throw new Error("Not authorized");if(!Number.isFinite(Number(t)))throw new Error("Invalid nodeId");let e=typeof csrfToken!="undefined"&&csrfToken||typeof window!="undefined"&&window&&window.csrfToken||null;if(!e)throw new Error("Missing csrfToken on page");let a=new URLSearchParams;a.set("nodeId",String(t)),a.set("_token",String(e));let n=await fetch("/en/main/map-rewards-unlock",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",body:a}),o=null;try{o=await n.json()}catch{}if(!n.ok){let d=o&&(o.message||o.error)||`HTTP ${n.status}`,l=new Error(d);throw l.status=n.status,l}return o||{message:"OK"}}function ue(t){let e=Math.max(0,Math.floor(t)),a=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60),d=e%60,l=[];return a&&l.push(`${a}d`),n&&l.push(`${n}h`),o&&l.length<2&&l.push(`${o}m`),l.length||l.push(`${d}s`),l.slice(0,2).join(" ")}function Se(t){try{return new Date(t).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}catch{let a=new Date(t),n=String(a.getHours()).padStart(2,"0"),o=String(a.getMinutes()).padStart(2,"0");return`${n}:${o}`}}var W=new Set([4690052,4571252,2707490,1714685,4407464]),Q=!1;function Ie(){if(!q("quest poller init"))return;let t="/en/main/anniversaryQuestData",e=!1,a=0,n=null,o=null,d=!1,l=new Map,y=()=>{let s=Date.now();for(let[i,m]of l)s-m>2*6e4&&l.delete(i)},E=async()=>{if(q("quest poll")&&!e){e=!0;try{let s=await fetch(t,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest",accept:"application/json, text/javascript, */*; q=0.01"},credentials:"same-origin",cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);let i=await s.json(),m=i&&i.status&&Array.isArray(i.status.queue)?i.status.queue:[],v=m.length>=3;if(S("QuestData queue size:",m.length),v){let T="No empty slots";try{let L=m.map(C=>Number(C&&C.remainingTime)).filter(C=>Number.isFinite(C)&&C>0);if(L.length>0){let C=Math.min(...L),I=Math.max(0,Math.ceil(C/60)*60),f=Date.now()+I*1e3;T+=` â€” next in ${ue(I)} (at ${Se(f)})`}}catch{}A(T,{kind:"warn",ttl:4e3,dedupeFor:59e3})}else try{let T=i&&i.status&&i.status.progress||{},L=Array.isArray(i&&i.neighbors)?i.neighbors:[],C=i&&i.cities||{},I=new Set(m.map(c=>c&&c.nodeId).filter(Boolean)),f=new Set(Object.values(T).filter(c=>c&&(c.nodeStatus==="unclaimed"||c.nodeStatus==="claimed")).map(c=>c.nodeId)),j=new Set(Object.values(T).filter(c=>c&&c.nodeStatus==="unlocking").map(c=>c.nodeId)),h=new Set([...f,...I,...j]);if(h.size>0&&L.length>0){let c=new Set;L.forEach(u=>{!u||typeof u.nodeId!="number"||typeof u.neighborId!="number"||(h.has(u.nodeId)&&c.add(u.neighborId),h.has(u.neighborId)&&c.add(u.nodeId))});let M=[...c].filter(u=>!f.has(u)).filter(u=>!I.has(u)).filter(u=>!j.has(u));if(M.length>0){let F=`Available cities to open: ${M.map(k=>{let $=C&&C[k];return $&&$.name?$.name:String(k)}).join(", ")}`;if(A(F,{kind:"info",ttl:5e4,dedupeFor:5e4}),y(),!d&&q("auto open city")){let k=M.find($=>!l.has($));if(typeof k=="number"){d=!0,l.set(k,Date.now());let $=C&&C[k]&&C[k].name||String(k);Ee(k).then(b=>{let B=b&&b.message||"Successfully started node unlock";A(`Added to queue: ${$} (#${k}) â€” ${B}`,{kind:"info",ttl:8e3,dedupeFor:4e3})}).catch(b=>{let B=b&&b.message?b.message:"Failed to add city to queue";A(`Failed to add ${$} (#${k}) â€” ${B}`,{kind:"error",ttl:9e3,dedupeFor:2e3})}).finally(()=>{d=!1,setTimeout(()=>{E()},150)})}}}}}catch(T){S("Next cities suggestion failed",T)}o=v,a=0}catch(s){a+=1,S("QuestData poll failed",s),a===3&&A("Anniversary data polling temporarily failing",{kind:"error",ttl:5e3,dedupeFor:15*6e4})}finally{e=!1}}};E(),n=setInterval(E,6e4),window.addEventListener("beforeunload",()=>{n&&clearInterval(n)},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",se,{once:!0}):se();})();
